api_release_main:
  stage: build
  image: docker:28.5.1
  tags:
    - tls-dind-kubernetes-runner
  services:
    - name: docker:28.5.1-dind
      variables:
        HEALTHCHECK_TCP_PORT: "2376"

  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    COMPONENT: api
    TARGET_ENV: main
    BUILD_CONTEXT: api
    DOCKERFILE_PATH: api/Dockerfile

  needs:
    - job: api_semantic_release
      artifacts: true
      optional: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - api/**/*
        - kubernetes/**/*
        - .gitlab/ci/api-release-main.yml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: false
  before_script:
    - echo "Logging in to registry ${CI_REGISTRY}"
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
  script:
    - |
      set -eu
      IMAGE_REPO="${CI_REGISTRY_IMAGE:-${CI_REGISTRY}/${CI_PROJECT_PATH}}"
      IMAGE_REPO="$(echo "$IMAGE_REPO" | tr '[:upper:]' '[:lower:]')"
      COMPONENT_REPO="${IMAGE_REPO}/${COMPONENT}"
      RELEASE_VERSION="${API_RELEASE_VERSION:-}"
      if [ -z "$RELEASE_VERSION" ]; then
        echo "No API release version found; skipping Docker image build."
        exit 0
      fi
      VERSION_TAG="${COMPONENT_REPO}:${RELEASE_VERSION}"
      PRIMARY_IMAGE="${COMPONENT_REPO}:${TARGET_ENV}"
      LATEST_TAG="${COMPONENT_REPO}:latest"
      docker build --pull -f "$DOCKERFILE_PATH" \
        --build-arg VERSION="$RELEASE_VERSION" \
        --build-arg COMMIT="$CI_COMMIT_SHA" \
        --build-arg BUILD_DATE="$CI_JOB_STARTED_AT" \
        -t "$VERSION_TAG" "$BUILD_CONTEXT"
      docker tag "$VERSION_TAG" "$PRIMARY_IMAGE"
      docker tag "$VERSION_TAG" "$LATEST_TAG"
      for tag in "$VERSION_TAG" "$PRIMARY_IMAGE" "$LATEST_TAG"; do
        docker push "$tag"
      done
  after_script:
    - docker logout "$CI_REGISTRY"

pages:
  stage: deploy
  image: python:latest
  tags:
    - tls-dind-kubernetes-runner
  variables:
    GIT_DEPTH: "0"
  needs:
    - job: api_semantic_release
      artifacts: true
      optional: true
  script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source "$HOME/.local/bin/env"
    - export PATH="$HOME/.cargo/bin:$PATH"
    - cd api
    - |
      VERSION="${API_RELEASE_VERSION:-}"
      if [ -z "$VERSION" ]; then
        VERSION="$(git describe --tags --match 'api-v*' --abbrev=0 2>/dev/null || true)"
        case "$VERSION" in
          api-v*) VERSION="${VERSION#api-v}" ;;
        esac
      fi
      if [ -z "$VERSION" ]; then
        echo "No release version found; skipping doc deployment."
        exit 0
      fi

      git config user.name "CI"
      git config user.email "ci@example.com"
      git remote set-url origin "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"

      uv run mike deploy --config-file mkdocs.yml --branch gh-pages --remote origin --push --update "$VERSION" latest
      uv run mike set-default --config-file mkdocs.yml --branch gh-pages --remote origin --push latest
      uv run mkdocs build --config-file mkdocs.yml --site-dir ../public
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
