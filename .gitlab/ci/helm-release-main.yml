helm_chart_release:
  stage: release
  image:
    name: alpine/helm:3.14.0
    entrypoint: [""]
  tags:
    - tls-dind-kubernetes-runner
  variables:
    HELM_EXPERIMENTAL_OCI: "1"
    CHART_DIR: kubernetes/helm/minecharts
    CHART_DEST: dist
    HELM_CHANNEL: stable
  script:
    - helm version
    - apk add curl
    - mkdir -p "${CHART_DEST}"
    - helm dependency update "${CHART_DIR}"
    - helm package "${CHART_DIR}" -d "${CHART_DEST}"
    - CHART_PACKAGE="$(ls ${CHART_DEST}/minecharts-*.tgz | head -n1)"
    - |
      curl --fail-with-body --request POST \
        --user gitlab-ci-token:${CI_JOB_TOKEN} \
        --form "chart=@${CHART_PACKAGE}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/api/${HELM_CHANNEL}/charts"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - kubernetes/helm/**/*
        - .gitlab/ci/helm-release-main.yml
        - .gitlab-ci.yml
