api_build_dev:
  stage: build
  image: docker:28.5.1
  tags:
    - tls-dind-kubernetes-runner
  services:
    - name: docker:28.5.1-dind
      variables:
        HEALTHCHECK_TCP_PORT: "2376"

  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"

  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      changes:
        - api/**/*
        - kubernetes/**/*
        - .gitlab/ci/api-build-dev.yml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: false
  before_script:
    - echo "Logging in to registry ${CI_REGISTRY}"
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
  script:
    - |
      set -eu
      docker image build --pull -f "api/Dockerfile" -t "registry.prod.nasdak.fr/l.angonnet/minecharts/api" "api"
      docker push "registry.prod.nasdak.fr/l.angonnet/minecharts/api"
  after_script:
    - docker logout "$CI_REGISTRY"
