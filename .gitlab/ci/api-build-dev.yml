api_build_dev:
  stage: build
  image: docker:24.0.6
  tags:
    - tls-dind-kubernetes-runner
  services:
    - name: docker:24.0.6-dind
      variables:
        HEALTHCHECK_TCP_PORT: "2376"

  variables:
    COMPONENT: api
    TARGET_ENV: dev
    BUILD_CONTEXT: api
    DOCKERFILE_PATH: api/Dockerfile
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"

  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      changes:
        - api/**/*
        - kubernetes/**/*
        - .gitlab/ci/api-build-dev.yml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: false
  before_script:
    - echo "Logging in to registry ${CI_REGISTRY}"
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
  script:
    - |
      set -eu
      echo "CI_REGISTRY=${CI_REGISTRY:-}"
      echo "CI_REGISTRY_IMAGE=${CI_REGISTRY_IMAGE:-}"
      echo "CI_PROJECT_PATH=${CI_PROJECT_PATH:-}"
      echo "CI_COMMIT_SHA=${CI_COMMIT_SHA:-}"
      echo "COMPONENT=${COMPONENT:-}"
      echo "TARGET_ENV=${TARGET_ENV:-}"
      echo "BUILD_CONTEXT=${BUILD_CONTEXT:-}"
      echo "DOCKERFILE_PATH=${DOCKERFILE_PATH:-}"
      IMAGE_REPO="${CI_REGISTRY_IMAGE:-${CI_REGISTRY}/${CI_PROJECT_PATH}}"
      IMAGE_REPO="$(echo "$IMAGE_REPO" | tr '[:upper:]' '[:lower:]')"
      echo "IMAGE_REPO=${IMAGE_REPO}"
      SHORT_SHA="${CI_COMMIT_SHA:0:12}"
      echo "SHORT_SHA=${SHORT_SHA}"
      PRIMARY_IMAGE="${IMAGE_REPO}:${COMPONENT}-${TARGET_ENV}"
      echo "PRIMARY_IMAGE=${PRIMARY_IMAGE}"
      LATEST_TAG="${IMAGE_REPO}:${COMPONENT}-${TARGET_ENV}-latest"
      echo "LATEST_TAG=${LATEST_TAG}"
      SHA_TAG="${IMAGE_REPO}:${COMPONENT}-${TARGET_ENV}-${SHORT_SHA}"
      echo "SHA_TAG=${SHA_TAG}"
      echo "docker build --pull -f \"$DOCKERFILE_PATH\" -t \"$PRIMARY_IMAGE\" \"$BUILD_CONTEXT\""
      docker build --pull -f "$DOCKERFILE_PATH" -t "$PRIMARY_IMAGE" "$BUILD_CONTEXT"
      echo "docker tag \"$PRIMARY_IMAGE\" \"$LATEST_TAG\""
      docker tag "$PRIMARY_IMAGE" "$LATEST_TAG"
      echo "docker tag \"$PRIMARY_IMAGE\" \"$SHA_TAG\""
      docker tag "$PRIMARY_IMAGE" "$SHA_TAG"
      for tag in "$PRIMARY_IMAGE" "$LATEST_TAG" "$SHA_TAG"; do
        echo "docker push \"$tag\""
        docker push "$tag"
      done

  after_script:
    - docker logout "$CI_REGISTRY"
