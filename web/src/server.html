<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="route:access" content="private" />
    <title>Minecharts - Server</title>
    <script type="module" src="main.ts"></script>
    <script type="module" src="server.ts"></script>
    <style>
        body {
            opacity: 0;
        }
    </style>

</head>

<body class="min-h-screen flex flex-col bg-zinc-900 text-white" data-nav-active="servers">
    <header class="w-full" hx-get="./navbar.html" hx-trigger="load" hx-swap="innerHTML"></header>
    <div class="flex items-center justify-center flex-1 overflow-auto px-4 py-6">
        <div
            class="bg-zinc-800 w-full max-w-3xl rounded-xl p-6 sm:p-8 transition-all duration-500 ease-in-out border border-zinc-700/60 shadow-lg">
            <!-- Request server info -->
            <div id="server-info" x-data="serverInfo" class="space-y-6">
                <div class="hidden" x-ref="getServerInfo" :hx-get="`/api/servers/${serverName}`"
                    hx-trigger="load, refreshServerInfo" hx-swap="none"></div>

                <template x-if="notFound">
                    <div class="flex flex-col items-center gap-4 rounded-lg border border-zinc-700 bg-zinc-900/40 p-6 text-center"
                        x-transition>
                        <div class="text-4xl font-semibold text-zinc-400">404</div>
                        <h1 class="text-2xl font-semibold text-white">Server not found</h1>
                        <p class="max-w-sm text-sm text-zinc-400"
                            x-text="notFoundMessage || `We couldn't find that server.`"></p>
                        <a href="/dashboard.html"
                            class="rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition-all hover:bg-blue-500 hover:ring-2">
                            Back to dashboard
                        </a>
                    </div>
                </template>

                <template x-if="!notFound">
                    <div class="space-y-6" x-transition>
                        <div class="flex flex-col items-center gap-3 text-center">
                            <div class="flex items-center gap-3">
                                <div class="w-3 h-3 rounded-full"
                                    :class="status === 'running' ? 'bg-green-500' : status === 'stopped' ? 'bg-red-500' : 'bg-zinc-500'">
                                </div>
                                <span class="font-bold text-2xl" x-text="serverName || 'Unknown server'"></span>
                            </div>
                            <div class="text-sm text-zinc-400">
                                <span class="uppercase tracking-wide font-semibold">Status:</span>
                                <span class="font-medium capitalize" x-text="status ? status : 'unknown'"></span>
                            </div>
                        </div>

                        <div class="w-full rounded-lg border border-zinc-700 bg-zinc-900/40 p-4">
                            <dl class="grid grid-cols-1 gap-4 text-sm sm:grid-cols-2">
                                <div>
                                    <dt class="text-xs uppercase tracking-wide text-zinc-500">Server ID</dt>
                                    <dd class="font-mono text-zinc-100 break-all" x-text="id || '—'"></dd>
                                </div>
                                <div>
                                    <dt class="text-xs uppercase tracking-wide text-zinc-500">Server URL</dt>
                                    <dd class="font-mono text-zinc-100 break-all" x-text="serverUrl || '—'"></dd>
                                </div>
                                <div>
                                    <dt class="text-xs uppercase tracking-wide text-zinc-500">Last update</dt>
                                    <dd class="text-zinc-100" x-text="updatedAt || '—'"></dd>
                                </div>
                                <div>
                                    <dt class="text-xs uppercase tracking-wide text-zinc-500">Created at</dt>
                                    <dd class="text-zinc-100" x-text="createdAt || '—'"></dd>
                                </div>
                            </dl>
                        </div>

                        <div x-show="actionFeedbackMessage" x-transition
                            :class="actionFeedbackType === 'error' ? 'bg-red-500/10 text-red-300 border-red-500/40' : 'bg-green-500/10 text-green-200 border-green-500/40'"
                            class="rounded-lg border p-3 text-sm">
                            <span x-text="actionFeedbackMessage"></span>
                        </div>

                        <div class="flex flex-wrap justify-center gap-3" x-ref="actionButtons">
                            <button data-server-action="start" x-show="status !== 'running'"
                                class="bg-green-600 hover:bg-green-700 text-white rounded-lg hover:ring-2 transition-all px-4 py-2"
                                :hx-post="`/api/servers/${serverName}/start`" hx-swap="none"
                                :hx-confirm="serverName ? `Start ${serverName}?` : 'Start this server?'">
                                Start
                            </button>

                            <button data-server-action="restart" x-show="status === 'running'"
                                class="bg-blue-500 hover:bg-blue-600 text-white rounded-lg hover:ring-2 transition-all px-4 py-2"
                                :hx-post="`/api/servers/${serverName}/restart`" hx-swap="none"
                                :hx-confirm="serverName ? `Restart ${serverName}?` : 'Restart this server?'">
                                Restart
                            </button>

                            <button data-server-action="stop" x-show="status === 'running'"
                                class="bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg hover:ring-2 transition-all px-4 py-2"
                                :hx-post="`/api/servers/${serverName}/stop`" hx-swap="none"
                                :hx-confirm="serverName ? `Stop ${serverName}?` : 'Stop this server?'">
                                Stop
                            </button>

                            <button data-server-action="delete"
                                class="bg-red-600 hover:bg-red-700 text-white rounded-lg hover:ring-2 transition-all px-4 py-2"
                                :hx-post="`/api/servers/${serverName}/delete`" hx-swap="none"
                                :hx-confirm="serverName ? `Warning: delete ${serverName}?\nThis will permanently remove the server and its data.` : 'Warning: delete this server?\nThis will permanently remove the server and its data.'">
                                Delete
                            </button>
                        </div>

                        <div class="rounded-lg border border-zinc-700 bg-zinc-900/40 p-4 space-y-4">
                            <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                                <div>
                                    <h2 class="text-lg font-semibold text-white">Server console</h2>
                                    <p class="text-sm text-zinc-400">Live logs from the Minecraft server with command input below.</p>
                                </div>
                                <div class="flex flex-wrap items-center gap-2 text-xs text-zinc-400">
                                    <span class="rounded-md border border-zinc-700/70 bg-zinc-800/70 px-2 py-1 font-medium"
                                        x-text="logStatus || 'Idle'"></span>
                                    <button type="button"
                                        class="rounded-md border border-zinc-600/60 px-2 py-1 font-medium text-zinc-300 transition-all hover:border-zinc-500 hover:text-white"
                                        @click="logAutoscroll = true; scrollConsoleToBottom();"
                                        x-show="!logAutoscroll">
                                        Follow
                                    </button>
                                    <button type="button"
                                        class="rounded-md border border-zinc-600/60 px-2 py-1 font-medium text-zinc-300 transition-all hover:border-zinc-500 hover:text-white disabled:cursor-not-allowed disabled:border-zinc-700/60 disabled:text-zinc-500"
                                        :disabled="!hasConsoleLogs"
                                        @click="clearConsole()">
                                        Clear
                                    </button>
                                    <div class="relative">
                                        <button type="button"
                                            class="flex h-6 w-6 items-center justify-center rounded-full border border-zinc-600/60 text-zinc-300 transition-all hover:border-zinc-500 hover:text-white"
                                            @click="showLogLegend = !showLogLegend"
                                            :aria-expanded="showLogLegend"
                                            aria-haspopup="true"
                                            title="Log legend">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                                class="h-4 w-4" fill="currentColor">
                                                <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 3a1.25 1.25 0 1 1-1.25 1.25A1.25 1.25 0 0 1 12 5Zm1.5 12.25h-3a.75.75 0 0 1 0-1.5h1v-3h-.25a.75.75 0 0 1 0-1.5h1a.75.75 0 0 1 .75.75v3.75h.5a.75.75 0 0 1 0 1.5Z" />
                                            </svg>
                                        </button>
                                        <div x-show="showLogLegend" @click.outside="showLogLegend = false"
                                            x-transition
                                            class="absolute right-0 top-8 z-10 w-60 rounded-md border border-zinc-700 bg-zinc-900/95 p-3 text-xs text-zinc-300 shadow-xl">
                                            <div class="mb-2 font-semibold text-white">Legend</div>
                                            <ul class="space-y-1">
                                                <li class="flex items-center gap-2">
                                                    <span class="inline-flex h-2 w-2 rounded-full bg-emerald-300"></span>
                                                    <span>Info</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="inline-flex h-2 w-2 rounded-full bg-amber-300"></span>
                                                    <span>Warnings</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="inline-flex h-2 w-2 rounded-full bg-red-300"></span>
                                                    <span>Errors</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="inline-flex h-2 w-2 rounded-full bg-sky-300"></span>
                                                    <span>Debug messages</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="inline-flex h-2 w-2 rounded-full bg-zinc-400"></span>
                                                    <span>Other</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="h-64 overflow-y-auto rounded-md border border-zinc-700/80 bg-black/60 p-3 space-y-1 text-xs"
                                x-ref="consoleViewport">
                                <template x-if="!hasConsoleLogs">
                                    <div class="font-mono text-zinc-500">Waiting for log entries…</div>
                                </template>
                                <template x-for="entry in logMessages" :key="entry.key">
                                    <div class="font-mono break-words flex items-start gap-3" :class="entry.className">
                                        <span class="text-zinc-500" x-text="entry.time" x-show="entry.time"></span>
                                        <span class="whitespace-pre-wrap" x-text="entry.text || ' '"></span>
                                    </div>
                                </template>
                            </div>

                            <form x-ref="commandForm" data-server-action="exec" hx-ext="json-enc" method="post"
                                :hx-post="`/api/servers/${serverName}/exec`" hx-swap="none"
                                class="flex flex-col gap-3 sm:flex-row">
                                <input type="text" name="command" x-model.trim="command"
                                    class="flex-1 rounded-md border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-white placeholder:text-zinc-500 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    placeholder='e.g. say "Hello, world!"' required />
                                <button type="submit" :disabled="command === ''"
                                    class="rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition-all hover:bg-blue-500 hover:ring-2 disabled:cursor-not-allowed disabled:bg-blue-600/50 disabled:text-white/60">
                                    Send
                                </button>
                            </form>

                            <div x-show="commandResult" x-transition
                                :class="commandResultType === 'error' ? 'border-red-500/40 bg-red-500/10 text-red-200' : 'border-green-500/40 bg-green-500/10 text-green-200'"
                                class="overflow-auto rounded-md border p-3 text-sm">
                                <pre class="whitespace-pre-wrap break-words font-mono text-xs"
                                    x-text="commandResult"></pre>
                            </div>
                        </div>

                        <template x-if="hasEnvironment">
                            <div class="rounded-lg border border-zinc-700 bg-zinc-900/40 p-4 space-y-2">
                                <h2 class="text-lg font-semibold text-white">Environment variables</h2>
                                <ul class="space-y-1 text-sm">
                                    <template x-for="env in environment"
                                        :key="env.key ? env.key + env.value : env.value">
                                        <li
                                            class="flex flex-col rounded border border-zinc-700/40 bg-zinc-800/60 px-3 py-2 sm:flex-row sm:items-center sm:justify-between">
                                            <span class="font-mono text-zinc-200" x-text="env.key"></span>
                                            <span class="font-mono text-xs text-zinc-400 sm:ml-4 sm:text-sm"
                                                x-text="env.value"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </div>
</body>
